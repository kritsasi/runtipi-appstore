version: '3.9'

services:
  openflow:
    container_name: openflow
    image: openiap/openflow:1.5.12.29
    restart: unless-stopped
    ports:
      - ${APP_PORT}:80
    depends_on:
      openflow-db:
        condition: service_healthy
      openflow-mq:
        condition: service_healthy
    networks:
      - tipi_main_network
    environment:
      - protocol=${APP_PROTOCOL}
      - domain=${APP_DOMAIN}
      - cookie_secret=${OPENFLOW_COOKIE_SECRET}
      - aes_secret=${OPENFLOW_AES_SECRET}
      - TZ=${TZ}
    labels:
      # Main
      traefik.enable: true
      traefik.http.middlewares.openflow-web-redirect.redirectscheme.scheme: https
      traefik.http.services.openflow.loadbalancer.server.port: 80
      # Web
      traefik.http.routers.openflow-insecure.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.openflow-insecure.entrypoints: web
      traefik.http.routers.openflow-insecure.service: openflow
      traefik.http.routers.openflow-insecure.middlewares: openflow-web-redirect
      # Websecure
      traefik.http.routers.openflow.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.openflow.entrypoints: websecure
      traefik.http.routers.openflow.service: openflow
      traefik.http.routers.openflow.tls.certresolver: myresolver
      # Local domain
      traefik.http.routers.openflow-local-insecure.rule: Host(`openflow.${LOCAL_DOMAIN}`)
      traefik.http.routers.openflow-local-insecure.entrypoints: web
      traefik.http.routers.openflow-local-insecure.service: openflow
      traefik.http.routers.openflow-local-insecure.middlewares: openflow-web-redirect
      # Local domain secure
      traefik.http.routers.openflow-local.rule: Host(`openflow.${LOCAL_DOMAIN}`)
      traefik.http.routers.openflow-local.entrypoints: websecure
      traefik.http.routers.openflow-local.service: openflow
      traefik.http.routers.openflow-local.tls: true
      runtipi.managed: true

  openflow-db:
    container_name: openflow-db
    image: mongo:8.0.12
    restart: unless-stopped
    networks:
      - tipi_main_network
    volumes:
      - ${APP_DATA_DIR}/data/mongo:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - TZ=${TZ}
    command: --serviceExecutor adaptive
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' | grep 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    labels:
      runtipi.managed: true

  openflow-dbexp:
    container_name: openflow-dbexp
    image: mongo-express:1.0.2
    restart: unless-stopped
    networks:
      - tipi_main_network
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=admin
      - ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - ME_CONFIG_MONGODB_URL=mongodb://admin:${MONGO_INITDB_ROOT_PASSWORD}@openflow-db:27017/
      - ME_CONFIG_BASICAUTH=false
    labels:
      runtipi.managed: true
      
  openflow-mq:
    container_name: openflow-mq
    image: rabbitmq:3-management
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/data/rabbitmq:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=${OPENFLOW_MQ_PASS}
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - tipi_main_network
    labels:
      runtipi.managed: true
