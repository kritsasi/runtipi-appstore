{
  "$schema": "../dynamic-compose-schema.json",
  "services": [
    {
      "name": "openflow",
      "image": "openiap/openflow:1.5.12.35",
      "isMain": true,
      "internalPort": 3000,
      "addPorts": [
        { "containerPort": 50051, "hostPort": 50051, "tcp": true },
        { "containerPort": 5858, "hostPort": 5858, "tcp": true }
      ],
      "deploy": {
        "replicas": 1
      },
      "environment": {
        "protocol": "${APP_PROTOCOL}",
        "domain": "${APP_DOMAIN}",
        "agent_oidc_userinfo_endpoint": "http://api:3000/oidc/me",
        "agent_oidc_issuer": "http://${DOMAIN}/oidc",
        "agent_oidc_authorization_endpoint": "http://${DOMAIN}/oidc/auth",
        "agent_oidc_token_endpoint": "http://api:3000/oidc/token",
        "amqp_url": "amqp://guest:guest@rabbitmq?frameMax=0x2000",
        "mongodb_url": "mongodb://mongodb:27017/?replicaSet=rs0",
        "mongodb_db": "openflow",
        "aes_secret": "${OPENFLOW_AES_SECRET}",
        "TZ": "${TZ}"
      },
      "volumes": [
        { 
          "hostPath": "/var/run/docker.sock", 
          "containerPath": "/var/run/docker.sock" 
        }
      ],
      "dependsOn": {
        "mongodb": { "condition": "service_healthy" },
        "rabbitmq": { "condition": "service_healthy" }
      }
    },
    {
      "name": "mongodb",
      "image": "mongo:8.0.12",
      "command": "--bind_ip_all --replSet rs0",
      "environment": {
        "MONGO_REPLICA_SET_NAME": "rs0",
        "MONGO_INITDB_DATABASE": "openflow"
        "TZ": "${TZ}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/mongo",
          "containerPath": "/data/db"
        }
      ],
      "healthCheck": {
        "interval": "10s",
        "timeout": "5s",
        "retries": 10,
        "startPeriod": "20s",
        "test": "sh -c \"mongosh --quiet --eval 'db.adminCommand({ ping: 1 }).ok' | grep 1\""
      }
    },
    {
      "name": "rabbitmq",
      "image": "rabbitmq:3-management",
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/rabbitmq",
          "containerPath": "/var/lib/rabbitmq"
        }
      ],
      "healthCheck": {
        "interval": "10s",
        "timeout": "5s",
        "retries": 12,
        "startPeriod": "20s",
        "test": "rabbitmq-diagnostics ping"
      }
    }
  ],
  "$schema": "../dynamic-compose-schema.json"
}
