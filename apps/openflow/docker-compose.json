{
  "services": [
    {
      "name": "openflow",
      "image": "openiap/openflow:1.5.12.29",
      "isMain": true,
      "internalPort": 80,
      "environment": {
        "protocol": "${APP_PROTOCOL}",
        "domain": "${APP_DOMAIN}",
        "cookie_secret": "${OPENFLOW_COOKIE_SECRET}",
        "aes_secret": "${OPENFLOW_AES_SECRET}",
        "MONGO_URI": "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@openflow-db:27017",
        "RABBITMQ_URI": "amqp://${OPENFLOW_MQ_USER}:${OPENFLOW_MQ_PASS}@openflow-mq:5672"
      },
      "dependsOn": {
        "openflow-db": { "condition": "service_healthy" },
        "openflow-mq": { "condition": "service_healthy" }
      }
    },
    {
      "name": "openflow-db",
      "image": "mongo:6.0",
      "environment": {
        "MONGO_INITDB_ROOT_USERNAME": "${MONGO_INITDB_ROOT_USERNAME}",
        "MONGO_INITDB_ROOT_PASSWORD": "${MONGO_INITDB_ROOT_PASSWORD}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/mongo",
          "containerPath": "/data/db"
        }
      ],
      "healthCheck": {
        "interval": "10s",
        "timeout": "5s",
        "retries": 10,
        "test": "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' | grep 1"
      }
    },
    {
      "name": "openflow-mq",
      "image": "rabbitmq:3-management",
      "environment": {
        "RABBITMQ_DEFAULT_USER": "${OPENFLOW_MQ_USER}",
        "RABBITMQ_DEFAULT_PASS": "${OPENFLOW_MQ_PASS}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/rabbitmq",
          "containerPath": "/var/lib/rabbitmq"
        }
      ],
      "healthCheck": {
        "interval": "10s",
        "timeout": "5s",
        "retries": 10,
        "test": "rabbitmq-diagnostics -q ping"
      }
    }
  ],
  "$schema": "../dynamic-compose-schema.json"
}
