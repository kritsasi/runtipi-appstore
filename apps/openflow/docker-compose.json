{
  "$schema": "../dynamic-compose-schema.json",
  "services": [
    {
      "name": "openflow",
      "image": "openiap/openflow:1.5.12.29",
      "isMain": true,
      "internalPort": 80,
      "deploy": {
        "replicas": 1
      },
      "environment": {
        "protocol": "${APP_PROTOCOL}",
        "domain": "${APP_DOMAIN}",
        "cookie_secret": "${OPENFLOW_COOKIE_SECRET}",
        "aes_secret": "${OPENFLOW_AES_SECRET}",
        "mongodb_url": "mongodb://admin:${MONGO_INITDB_ROOT_PASSWORD}@openflow-db:27017/?replicaSet=rs0",
        "mongodb_db": "openflow",
        "amqp_url": "amqp://guest:${OPENFLOW_MQ_PASS}@openflow-mq:5672?frameMax=0x2000",
        "TZ": "${TZ}"
      },
      "dependsOn": {
        "openflow-db": { "condition": "service_healthy" },
        "openflow-mq": { "condition": "service_healthy" }
      }
    },
    {
      "name": "openflow-db",
      "image": "mongo:8.0.12",
      "command": "--bind_ip_all --replSet rs0",
      "environment": {
        "MONGO_INITDB_ROOT_USERNAME": "admin",
        "MONGO_INITDB_ROOT_PASSWORD": "${MONGO_INITDB_ROOT_PASSWORD}",
        "MONGO_REPLICA_SET_NAME": "rs0",
        "TZ": "${TZ}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/mongo",
          "containerPath": "/data/db"
        }
      ],
      "healthCheck": {
        "interval": "10s",
        "timeout": "5s",
        "retries": 10,
        "test": "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' | grep 1"
      }
    },
    {
      "name": "openflow-dbsetup",
      "image": "mongo:8.0.12",
      "command": "mongosh --host openflow-db:27017 --eval  ' db = (new Mongo(\"openflow-db:27017\")).getDB(\"openflow\"); config = { \"_id\" : \"rs0\", \"members\" : [\n  {\n    \"_id\" : 0,\n    \"host\" : \"openflow-db:27017\"\n  }\n] }; rs.initiate(config); '\n",
      "dependsOn": {
        "openflow-db": {
          "condition": "service_started"
        }
      }
    },
    {
      "name": "openflow-mq",
      "image": "rabbitmq:3-management",
      "environment": {
        "RABBITMQ_DEFAULT_USER": "guest",
        "RABBITMQ_DEFAULT_PASS": "${OPENFLOW_MQ_PASS}",
        "TZ": "${TZ}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/rabbitmq",
          "containerPath": "/var/lib/rabbitmq"
        }
      ],
      "healthCheck": {
        "interval": "10s",
        "timeout": "5s",
        "retries": 10,
        "test": "rabbitmq-diagnostics -q ping"
      }
    }
  ],
  "$schema": "../dynamic-compose-schema.json"
}
